---
date: 2025-10-05
title: çº¿ä¸ŠæœåŠ¡å™¨æ­»é”æ€ä¹ˆæ’æŸ¥ï¼Ÿ
categories:
  - çº¿ä¸Šé—®é¢˜
draft: false
comments: true
---
**æ­»é”**æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹æŒæœ‰çš„èµ„æºï¼Œå¯¼è‡´æ‰€æœ‰çº¿ç¨‹éƒ½æ— æ³•ç»§ç»­æ‰§è¡Œçš„çŠ¶æ€ã€‚åœ¨çº¿ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ­»é”ä¼šå¯¼è‡´æœåŠ¡**éƒ¨åˆ†æˆ–å®Œå…¨ä¸å¯ç”¨**ï¼Œä¸”é€šå¸¸**ä¸ä¼šè‡ªåŠ¨æ¢å¤**ã€‚
<!-- more -->

## ğŸ’¥ ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿä¸ºä»€ä¹ˆå®ƒå¦‚æ­¤å±é™©ï¼Ÿ

```mermaid
graph TD
    A[çº¿ç¨‹AæŒæœ‰é”1] --> B[çº¿ç¨‹Aç­‰å¾…é”2]
    C[çº¿ç¨‹BæŒæœ‰é”2] --> D[çº¿ç¨‹Bç­‰å¾…é”1]
    B --> E[äº’ç›¸ç­‰å¾…]
    D --> E
    E --> F[ç¨‹åºå¡æ­»]
    
    style E fill:#ff4444,color:white
    style F fill:#ff4444,color:white
```

## ğŸ” æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶

1. **äº’æ–¥æ¡ä»¶**ï¼šèµ„æºä¸èƒ½è¢«å…±äº«ï¼Œåªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨
2. **è¯·æ±‚ä¸ä¿æŒæ¡ä»¶**ï¼šçº¿ç¨‹æŒæœ‰èµ„æºçš„åŒæ—¶è¯·æ±‚å…¶ä»–èµ„æº
3. **ä¸å¯å‰¥å¤ºæ¡ä»¶**ï¼šèµ„æºåªèƒ½ç”±æŒæœ‰çº¿ç¨‹ä¸»åŠ¨é‡Šæ”¾
4. **å¾ªç¯ç­‰å¾…æ¡ä»¶**ï¼šå¤šä¸ªçº¿ç¨‹å½¢æˆç¯å½¢ç­‰å¾…é“¾

## ğŸš¨ å¦‚ä½•å‘ç°æ­»é”ï¼Ÿ

### ç›‘æ§å‘Šè­¦ - ç¬¬ä¸€é“é˜²çº¿

**æ­»é”çš„å…¸å‹ç—‡çŠ¶**ï¼š

- âœ… æœåŠ¡æ¥å£è¶…æ—¶ç‡çªç„¶ä¸Šå‡
- âœ… çº¿ç¨‹æ± æ´»è·ƒçº¿ç¨‹æ•°å¼‚å¸¸å¢é«˜
- âœ… CPUä½¿ç”¨ç‡æ­£å¸¸ä½†ååé‡ä¸‹é™
- âœ… åº”ç”¨æ—¥å¿—ä¸­å‡ºç°çº¿ç¨‹é˜»å¡è­¦å‘Š

### å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# æ­»é”æ£€æµ‹è„šæœ¬
APP_PID=$(jps -l | grep your-app | awk '{print $1}')

if [ -z "$APP_PID" ]; then
    echo "åº”ç”¨æœªè¿è¡Œ"
    exit 1
fi

# æ£€æŸ¥çº¿ç¨‹çŠ¶æ€
THREAD_DUMP=$(jstack $APP_PID)
BLOCKED_THREADS=$(echo "$THREAD_DUMP" | grep -c "BLOCKED")
DEADLOCK_INFO=$(echo "$THREAD_DUMP" | grep -A 10 "deadlock")

if [ -n "$DEADLOCK_INFO" ]; then
    echo "ğŸ”´ æ£€æµ‹åˆ°æ­»é”ï¼"
    echo "$DEADLOCK_INFO"
    # å‘é€å‘Šè­¦
    send_alert "æ£€æµ‹åˆ°æ­»é”" "$DEADLOCK_INFO"
fi

if [ $BLOCKED_THREADS -gt 20 ]; then
    echo "ğŸŸ¡ æ£€æµ‹åˆ°å¤§é‡é˜»å¡çº¿ç¨‹: $BLOCKED_THREADS"
fi
```

## ğŸ•µï¸ æ­»é”æ’æŸ¥å®æˆ˜

### å®Œæ•´æ’æŸ¥æµç¨‹

```mermaid
flowchart TD
    A[å‘ç°æœåŠ¡å¼‚å¸¸] --> B[åˆæ­¥ç—‡çŠ¶åˆ†æ]
    B --> C{æ¥å£è¶…æ—¶ä½†CPUæ­£å¸¸}
    C -->|æ˜¯| D[æ€€ç–‘æ­»é”]
    C -->|å¦| E[å…¶ä»–é—®é¢˜æ’æŸ¥]
    
    D --> F[ç”Ÿæˆçº¿ç¨‹è½¬å‚¨]
    F --> G[åˆ†æçº¿ç¨‹çŠ¶æ€]
    G --> H[è¯†åˆ«æ­»é”çº¿ç¨‹]
    H --> I[å®šä½é—®é¢˜ä»£ç ]
    I --> J[ä¿®å¤æ­»é”]
    J --> K[éªŒè¯ä¿®å¤]
    
    style D fill:#ffeaa7
    style H fill:#ff6b6b
    style J fill:#74b9ff
```

### æ­¥éª¤1ï¼šç”Ÿæˆçº¿ç¨‹è½¬å‚¨ï¼ˆThread Dumpï¼‰

```bash
# æ–¹æ³•1ï¼šä½¿ç”¨jstackå‘½ä»¤
jstack -l <PID> > thread_dump_$(date +%Y%m%d_%H%M%S).log

# æ–¹æ³•2ï¼šä½¿ç”¨jcmdå‘½ä»¤
jcmd <PID> Thread.print > thread_dump.log

# æ–¹æ³•3ï¼šå‘è¿›ç¨‹å‘é€ä¿¡å·ï¼ˆLinuxï¼‰
kill -3 <PID>

# æ–¹æ³•4ï¼šä½¿ç”¨Arthas
thread -b > deadlock_threads.log
```

### æ­¥éª¤2ï¼šåˆ†æçº¿ç¨‹è½¬å‚¨

#### æŸ¥æ‰¾æ­»é”ä¿¡æ¯

åœ¨çº¿ç¨‹è½¬å‚¨æ–‡ä»¶ä¸­æœç´¢æ­»é”ç›¸å…³ä¿¡æ¯ï¼š

```bash
# æŸ¥æ‰¾æ­»é”æ ‡è®°
grep -i "deadlock" thread_dump.log

# æŸ¥æ‰¾é˜»å¡çš„çº¿ç¨‹
grep -B 5 -A 15 "BLOCKED" thread_dump.log

# æŸ¥æ‰¾ç­‰å¾…é”çš„çº¿ç¨‹
grep -B 5 -A 15 "waiting to lock" thread_dump.log
```

#### æ­»é”åˆ†æç¤ºä¾‹

**å…¸å‹çš„æ­»é”çº¿ç¨‹è½¬å‚¨**ï¼š
```
Found one Java-level deadlock:
=============================
"Thread-1":
  waiting to lock monitor 0x000000076adab1c0 (object 0x000000076b5bf1c0, a java.lang.Object),
  which is held by "Thread-0"
"Thread-0":
  waiting to lock monitor 0x000000076adab1d0 (object 0x000000076b5bf1d0, a java.lang.Object),
  which is held by "Thread-1"

Java stack information for the threads listed above:
===================================================
"Thread-1":
        at com.example.DeadLockExample.methodB(DeadLockExample.java:30)
        - waiting to lock <0x000000076b5bf1c0> (a java.lang.Object)
        - locked <0x000000076b5bf1d0> (a java.lang.Object)
        at com.example.DeadLockExample.runThread1(DeadLockExample.java:45)
"Thread-0":
        at com.example.DeadLockExample.methodA(DeadLockExample.java:15)
        - waiting to lock <0x000000076b5bf1d0> (a java.lang.Object)
        - locked <0x000000076b5bf1c0> (a java.lang.Object)
        at com.example.DeadLockExample.runThread0(DeadLockExample.java:40)
```

### æ­¥éª¤3ï¼šä½¿ç”¨å¯è§†åŒ–å·¥å…·åˆ†æ

#### JConsole / JVisualVM

```bash
# å¯åŠ¨JConsole
jconsole <PID>

# å¯åŠ¨JVisualVM  
jvisualvm
```

åœ¨JConsoleä¸­ï¼š
1. åˆ‡æ¢åˆ°"çº¿ç¨‹"æ ‡ç­¾é¡µ
2. ç‚¹å‡»"æ£€æµ‹æ­»é”"æŒ‰é’®
3. æŸ¥çœ‹æ­»é”çš„è¯¦ç»†ä¿¡æ¯

#### Arthasï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# å¯åŠ¨Arthas
java -jar arthas-boot.jar

# æ£€æµ‹æ­»é”
thread -b

# æŸ¥çœ‹æ‰€æœ‰çº¿ç¨‹çŠ¶æ€
thread

# æŸ¥çœ‹ç‰¹å®šçº¿ç¨‹çš„å †æ ˆ
thread <çº¿ç¨‹ID>
```

## ğŸ”§ æ­»é”ä»£ç æ¡ˆä¾‹ä¸åˆ†æ

### æ¡ˆä¾‹1ï¼šç»å…¸çš„å¾ªç¯ç­‰å¾…æ­»é”

```java
public class ClassicDeadlock {
    private final Object lockA = new Object();
    private final Object lockB = new Object();
    
    public void method1() {
        synchronized (lockA) {
            System.out.println(Thread.currentThread().getName() + " è·å– lockA");
            try { Thread.sleep(100); } catch (InterruptedException e) {}
            
            synchronized (lockB) {  // ğŸš¨ ç­‰å¾…lockB
                System.out.println(Thread.currentThread().getName() + " è·å– lockB");
            }
        }
    }
    
    public void method2() {
        synchronized (lockB) {
            System.out.println(Thread.currentThread().getName() + " è·å– lockB");
            try { Thread.sleep(100); } catch (InterruptedException e) {}
            
            synchronized (lockA) {  // ğŸš¨ ç­‰å¾…lockA
                System.out.println(Thread.currentThread().getName() + " è·å– lockA");
            }
        }
    }
    
    public static void main(String[] args) {
        ClassicDeadlock demo = new ClassicDeadlock();
        
        new Thread(demo::method1, "Thread-1").start();
        new Thread(demo::method2, "Thread-2").start();
    }
}
```

### æ¡ˆä¾‹2ï¼šæ•°æ®åº“äº‹åŠ¡æ­»é”

```java
@Service
public class OrderService {
    
    @Transactional
    public void transferMoney(Long fromAccountId, Long toAccountId, BigDecimal amount) {
        // ğŸš¨ å¯èƒ½å‘ç”Ÿæ•°æ®åº“æ­»é”
        Account fromAccount = accountRepository.findById(fromAccountId)
                            .orElseThrow(() -> new AccountNotFoundException(fromAccountId));
        Account toAccount = accountRepository.findById(toAccountId)
                          .orElseThrow(() -> new AccountNotFoundException(toAccountId));
        
        fromAccount.debit(amount);
        toAccount.credit(amount);
        
        accountRepository.save(fromAccount);
        accountRepository.save(toAccount);  // ä¸åŒçš„äº‹åŠ¡é¡ºåºå¯èƒ½å¯¼è‡´æ­»é”
    }
}
```

## ğŸ› ï¸ æ­»é”è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šé”é¡ºåºåŒ–

```java
public class LockOrderingSolution {
    private final Object lockA = new Object();
    private final Object lockB = new Object();
    
    // å®šä¹‰é”çš„è·å–é¡ºåº
    public void method1() {
        synchronized (lockA) {  // å…ˆè·å–lockA
            synchronized (lockB) {  // å†è·å–lockB
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
    
    public void method2() {
        synchronized (lockA) {  // åŒæ ·å…ˆè·å–lockA
            synchronized (lockB) {  // å†è·å–lockB
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
}
```

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨è¶…æ—¶æœºåˆ¶

```java
public class TimeoutLockSolution {
    private final Lock lockA = new ReentrantLock();
    private final Lock lockB = new ReentrantLock();
    
    public boolean transferWithTimeout() {
        try {
            if (lockA.tryLock(1, TimeUnit.SECONDS)) {
                try {
                    if (lockB.tryLock(1, TimeUnit.SECONDS)) {
                        try {
                            // ä¸šåŠ¡é€»è¾‘
                            return true;
                        } finally {
                            lockB.unlock();
                        }
                    }
                } finally {
                    lockA.unlock();
                }
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
        // è·å–é”è¶…æ—¶ï¼Œæ‰§è¡Œå›æ»šæˆ–é‡è¯•é€»è¾‘
        rollbackOperation();
        return false;
    }
}
```

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨åŸå­æ“ä½œ

```java
public class AtomicSolution {
    private final AtomicReference<BigDecimal> balanceA = new AtomicReference<>(BigDecimal.ZERO);
    private final AtomicReference<BigDecimal> balanceB = new AtomicReference<>(BigDecimal.ZERO);
    
    public boolean atomicTransfer(BigDecimal amount) {
        while (true) {
            BigDecimal currentA = balanceA.get();
            BigDecimal currentB = balanceB.get();
            
            if (currentA.compareTo(amount) < 0) {
                return false; // ä½™é¢ä¸è¶³
            }
            
            BigDecimal newA = currentA.subtract(amount);
            BigDecimal newB = currentB.add(amount);
            
            // CASæ“ä½œï¼Œé¿å…é”
            if (balanceA.compareAndSet(currentA, newA) && 
                balanceB.compareAndSet(currentB, newB)) {
                return true;
            }
            // é‡è¯•
        }
    }
}
```

### æ–¹æ¡ˆ4ï¼šæ•°æ®åº“æ­»é”å¤„ç†

```java
@Repository
public class AccountRepository {
    
    @Retryable(value = {CannotAcquireLockException.class, DeadlockLoserDataAccessException.class}, 
               maxAttempts = 3, backoff = @Backoff(delay = 100))
    @Transactional
    public void transferWithRetry(Long fromId, Long toId, BigDecimal amount) {
        // ä½¿ç”¨æ•°æ®åº“è¡Œé”ï¼ŒæŒ‰å›ºå®šé¡ºåºæ›´æ–°
        String sql = "UPDATE accounts SET balance = balance - ? WHERE id = ? AND balance >= ?";
        jdbcTemplate.update(sql, amount, Math.min(fromId, toId), amount);
        jdbcTemplate.update(sql, amount, Math.max(fromId, toId), amount);
    }
}
```

## ğŸ“‹ æ­»é”é¢„é˜²æœ€ä½³å®è·µ

### 1. ä»£ç å¼€å‘è§„èŒƒ

```java
// âœ… å¥½çš„å®è·µï¼šä½¿ç”¨ç»Ÿä¸€çš„é”é¡ºåº
public class LockManager {
    private static final Object FIRST_LOCK = new Object();
    private static final Object SECOND_LOCK = new Object();
    
    public void operation1() {
        synchronized (FIRST_LOCK) {
            synchronized (SECOND_LOCK) {
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
    
    public void operation2() {
        synchronized (FIRST_LOCK) {
            synchronized (SECOND_LOCK) {
                // ä¸šåŠ¡é€»è¾‘
            }
        }
    }
}

// âœ… ä½¿ç”¨æ›´é«˜å±‚æ¬¡çš„å¹¶å‘å·¥å…·
public class ConcurrentService {
    private final ExecutorService executor = Executors.newFixedThreadPool(10);
    private final Phaser phaser = new Phaser();
    
    public void processConcurrently(List<Runnable> tasks) {
        tasks.forEach(task -> executor.submit(() -> {
            phaser.register();
            try {
                task.run();
            } finally {
                phaser.arriveAndDeregister();
            }
        }));
        phaser.awaitAdvance(phaser.getPhase());
    }
}
```

### 2. æ¶æ„è®¾è®¡å»ºè®®

```mermaid
graph TD
    A[å¾®æœåŠ¡æ¶æ„] --> B[é¿å…åˆ†å¸ƒå¼é”]
    A --> C[ä½¿ç”¨å¼‚æ­¥æ¶ˆæ¯]
    A --> D[å®ç°å¹‚ç­‰æ€§]
    
    B --> E[æœ€ç»ˆä¸€è‡´æ€§]
    C --> F[äº‹ä»¶é©±åŠ¨]
    D --> G[é‡è¯•å®‰å…¨]
    
    style B fill:#74b9ff
    style C fill:#74b9ff
    style D fill:#74b9ff
```

### 3. ç›‘æ§å’Œå‘Šè­¦é…ç½®

**Prometheuså‘Šè­¦è§„åˆ™**ï¼š
```yaml
groups:
- name: deadlock_detection
  rules:
  - alert: ThreadDeadlock
    expr: increase(jvm_threads_deadlock[5m]) > 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "æ£€æµ‹åˆ°JVMçº¿ç¨‹æ­»é”"
      
  - alert: HighBlockedThreads
    expr: jvm_threads_blocked > 10
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "é˜»å¡çº¿ç¨‹æ•°è¶…è¿‡é˜ˆå€¼"
```

## ğŸš€ é«˜çº§æ’æŸ¥æŠ€å·§

### ä½¿ç”¨Arthasè¿›è¡Œå®æ—¶è¯Šæ–­

```bash
# 1. å¯åŠ¨Arthaså¹¶é™„åŠ åˆ°ç›®æ ‡è¿›ç¨‹
java -jar arthas-boot.jar

# 2. å®æ—¶ç›‘æ§çº¿ç¨‹çŠ¶æ€
dashboard

# 3. æ£€æµ‹æ­»é”
thread -b

# 4. ç›‘æ§æ–¹æ³•è°ƒç”¨
watch com.example.Service * '{params, target, returnObj}' -x 3

# 5. ç”Ÿæˆç«ç„°å›¾åˆ†ææ€§èƒ½
profiler start
profiler stop --format html
```

### è‡ªåŠ¨åŒ–æ­»é”æ£€æµ‹è„šæœ¬

```bash
#!/bin/bash
# è‡ªåŠ¨åŒ–æ­»é”æ£€æµ‹å’Œæ¢å¤è„šæœ¬

detect_and_recover_deadlock() {
    local APP_NAME=$1
    local PID=$(jps -l | grep $APP_NAME | awk '{print $1}')
    
    if [ -z "$PID" ]; then
        echo "åº”ç”¨æœªè¿è¡Œ"
        return 1
    fi
    
    # æ£€æµ‹æ­»é”
    local DEADLOCK_INFO=$(jstack $PID | grep -A 20 "deadlock")
    
    if [ -n "$DEADLOCK_INFO" ]; then
        echo "æ£€æµ‹åˆ°æ­»é”ï¼Œæ­£åœ¨ç”Ÿæˆè¯Šæ–­ä¿¡æ¯..."
        
        # ç”Ÿæˆå®Œæ•´çš„è¯Šæ–­åŒ…
        jstack $PID > /tmp/thread_dump_$PID.log
        jmap -histo:live $PID > /tmp/heap_histo_$PID.log
        
        # å‘é€å‘Šè­¦
        send_alert "æ­»é”æ£€æµ‹" "$DEADLOCK_INFO"
        
        # æ ¹æ®ç­–ç•¥å†³å®šæ˜¯å¦é‡å¯
        if [ "$AUTO_RECOVER" = "true" ]; then
            echo "è‡ªåŠ¨æ¢å¤ï¼šé‡å¯åº”ç”¨"
            restart_application
        fi
        
        return 0
    else
        echo "æœªæ£€æµ‹åˆ°æ­»é”"
        return 1
    fi
}
```

## ğŸ“Š æ­»é”æ’æŸ¥å·¥å…·ç®±

| å·¥å…· | ç”¨é€” | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `jstack` | çº¿ç¨‹è½¬å‚¨åˆ†æ | åŸºç¡€æ­»é”æ£€æµ‹ |
| `jcmd` | çº¿ç¨‹åˆ†æ | JDK7+ æ¨è |
| JConsole | å›¾å½¢åŒ–ç›‘æ§ | å¼€å‘ç¯å¢ƒ |
| JVisualVM | é«˜çº§åˆ†æ | æ€§èƒ½ profiling |
| Arthas | åœ¨çº¿è¯Šæ–­ | ç”Ÿäº§ç¯å¢ƒé¦–é€‰ |
| APMå·¥å…· | å…¨é“¾è·¯ç›‘æ§ | åˆ†å¸ƒå¼ç³»ç»Ÿ |

## ğŸ’¡ æ€»ç»“ä¸ç»éªŒåˆ†äº«

### æ’æŸ¥å¿ƒæ³•

```mermaid
graph TD
    A[æœåŠ¡å¼‚å¸¸] --> B[å¿«é€Ÿç¡®è®¤ç—‡çŠ¶]
    B --> C[ä¿ç•™é—®é¢˜ç°åœº]
    C --> D[å¤šå·¥å…·äº¤å‰éªŒè¯]
    D --> E[å®šä½æ ¹æœ¬åŸå› ]
    E --> F[å®æ–½ä¿®å¤æ–¹æ¡ˆ]
    F --> G[éªŒè¯å’Œç›‘æ§]
    
    style B fill:#ffeaa7
    style E fill:#ff6b6b
    style G fill:#00b894
```

> ğŸ¯ **è®°ä½**ï¼šæ­»é”é—®é¢˜ä¸ä¼šè‡ªè¡Œè§£å†³ï¼Œå¿…é¡»ä¸»åŠ¨å¹²é¢„ã€‚å»ºç«‹å®Œå–„çš„ç›‘æ§ä½“ç³»å’Œæ’æŸ¥æµç¨‹ï¼Œæ‰èƒ½åœ¨æ­»é”å‘ç”Ÿæ—¶å¿«é€Ÿå®šä½å¹¶è§£å†³é—®é¢˜ã€‚